<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Analysis Lab</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@0.474.0/dist/umd/lucide.min.js"></script>

  <!-- Tone.js -->
  <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>

  <style>
    @keyframes fade-in { from { opacity:0; transform: translateY(8px);} to { opacity:1; transform: translateY(0);} }
    @keyframes slide-up { from { opacity:0; transform: translateY(20px);} to { opacity:1; transform: translateY(0);} }
    @keyframes pulse-slow { 0%,100% { opacity:.35; transform: scale(1);} 50% { opacity:.6; transform: scale(1.05);} }
    @keyframes float { 0%,100% { transform: translateY(0);} 50% { transform: translateY(-10px);} }

    .animate-fade-in { animation: fade-in .35s ease-out both; }
    .animate-slide-up { animation: slide-up .35s ease-out both; }
    .animate-pulse-slow { animation: pulse-slow 6s ease-in-out infinite; }
    .floaty { animation: float 4s ease-in-out infinite; }

    /* iOS tap highlight polish */
    button { -webkit-tap-highlight-color: transparent; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-gray-900 via-slate-900 to-gray-900 text-white p-4 md:p-8 font-sans relative overflow-hidden">
  <!-- background blobs -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-0 left-1/4 w-96 h-96 bg-cyan-500/10 rounded-full blur-3xl animate-pulse-slow"></div>
    <div class="absolute bottom-0 right-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl animate-pulse-slow" style="animation-delay:1s"></div>
    <div class="absolute top-1/2 left-1/2 w-96 h-96 bg-green-500/10 rounded-full blur-3xl animate-pulse-slow" style="animation-delay:2s"></div>
  </div>

  <main class="max-w-6xl mx-auto relative z-10">
    <!-- Header -->
    <header class="mb-10 text-center">
      <div class="flex items-center justify-center gap-4 mb-4">
        <i data-lucide="brain" class="text-cyan-400"></i>
        <h1 class="text-5xl md:text-7xl font-black bg-gradient-to-r from-cyan-400 via-purple-400 to-green-400 bg-clip-text text-transparent">
          The Analysis Lab
        </h1>
      </div>
      <p class="text-lg md:text-xl text-gray-300 max-w-2xl mx-auto font-light">
        Master critical thinking through interactive challenges
      </p>

      <div class="flex items-center justify-center gap-4 md:gap-6 mt-6">
        <div class="bg-gray-800/50 px-5 py-2.5 rounded-full border border-cyan-500/30">
          <span class="text-cyan-400 font-bold text-lg">Score: <span id="score">0</span></span>
        </div>

        <button id="soundBtn" class="bg-gray-800/50 p-3 rounded-full border border-purple-500/30 hover:bg-gray-700/50 transition-colors" aria-label="Toggle sound">
          <i id="soundIcon" data-lucide="volume-x" class="text-gray-500"></i>
        </button>
      </div>
    </header>

    <!-- HOME -->
    <section id="home" class="space-y-8 animate-fade-in">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="moduleGrid"></div>

      <div class="bg-gradient-to-r from-gray-800/50 to-gray-700/50 p-8 rounded-3xl border border-gray-700 text-center">
        <h3 class="text-2xl font-bold mb-3 bg-gradient-to-r from-cyan-400 to-green-400 bg-clip-text text-transparent">
          Why Critical Thinking Matters
        </h3>
        <p class="text-gray-300 text-lg font-light max-w-3xl mx-auto">
          These four skills help you understand the world deeply: see how events connect, evaluate arguments carefully,
          recognize patterns in complex systems, and test ideas with evidence. Master them, and you'll make better decisions
          in every area of life.
        </p>
      </div>
    </section>

    <!-- GAME -->
    <section id="game" class="hidden">
      <button id="backBtn" class="mb-6 px-6 py-3 bg-gray-800/50 rounded-xl border border-gray-700 hover:bg-gray-700/50 transition-colors text-gray-300 hover:text-white flex items-center gap-2">
        ← Back to Modules
      </button>

      <div id="gameHost" class="animate-fade-in"></div>
    </section>
  </main>

  <script>
    // -------------------------
    // State
    // -------------------------
    const state = {
      score: 0,
      soundEnabled: false,
      selectedModule: null,
      synth: null
    };

    const scoreEl = document.getElementById("score");
    const homeEl = document.getElementById("home");
    const gameEl = document.getElementById("game");
    const gameHost = document.getElementById("gameHost");
    const backBtn = document.getElementById("backBtn");
    const soundBtn = document.getElementById("soundBtn");
    const soundIcon = document.getElementById("soundIcon");

    function setScore(next) {
      state.score = next;
      scoreEl.textContent = String(next);
    }

    async function ensureAudio() {
      try {
        // iOS requires a user gesture; this is called from button taps
        if (Tone.context.state !== "running") await Tone.start();
      } catch (e) {
        // ignore
      }
      if (!state.synth) {
        state.synth = new Tone.Synth({
          oscillator: { type: "sine" },
          envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
        }).toDestination();
        state.synth.volume.value = -10;
      }
    }

    function playSound(note, duration = "16n") {
      if (!state.soundEnabled || !state.synth) return;
      try { state.synth.triggerAttackRelease(note, duration); } catch {}
    }

    // -------------------------
    // Modules meta
    // -------------------------
    const modules = [
      {
        id: "cause-effect",
        title: "Cause & Effect Explorer",
        icon: "git-branch",
        color: "from-cyan-500 to-blue-600",
        description: "Trace chains of events and understand causality",
        gradient: "bg-gradient-to-br from-cyan-500/20 to-blue-600/20"
      },
      {
        id: "argument",
        title: "Argument Analyzer",
        icon: "message-square",
        color: "from-purple-500 to-pink-600",
        description: "Break down reasoning and evaluate claims",
        gradient: "bg-gradient-to-br from-purple-500/20 to-pink-600/20"
      },
      {
        id: "systems",
        title: "System Thinker",
        icon: "target",
        color: "from-orange-500 to-red-600",
        description: "See how parts interact in complex systems",
        gradient: "bg-gradient-to-br from-orange-500/20 to-red-600/20"
      },
      {
        id: "scientific",
        title: "Scientific Method Lab",
        icon: "microscope",
        color: "from-green-500 to-emerald-600",
        description: "Form hypotheses and test with evidence",
        gradient: "bg-gradient-to-br from-green-500/20 to-emerald-600/20"
      }
    ];

    function showHome() {
      state.selectedModule = null;
      gameEl.classList.add("hidden");
      homeEl.classList.remove("hidden");
      gameHost.innerHTML = "";
    }

    function showGame(moduleId) {
      state.selectedModule = moduleId;
      homeEl.classList.add("hidden");
      gameEl.classList.remove("hidden");
      renderGame(moduleId);
    }

    backBtn.addEventListener("click", async () => {
      await ensureAudio();
      playSound("C4", "16n");
      showHome();
    });

    soundBtn.addEventListener("click", async () => {
      await ensureAudio();
      state.soundEnabled = !state.soundEnabled;
      soundIcon.setAttribute("data-lucide", state.soundEnabled ? "volume-2" : "volume-x");
      soundIcon.className = state.soundEnabled ? "text-purple-400" : "text-gray-500";
      lucide.createIcons();
      playSound("A4", "32n");
    });

    // -------------------------
    // Render module cards
    // -------------------------
    function renderHomeCards() {
      const grid = document.getElementById("moduleGrid");
      grid.innerHTML = "";

      modules.forEach((m, index) => {
        const btn = document.createElement("button");
        btn.className = `${m.gradient} p-8 rounded-3xl border-2 border-gray-700 hover:border-opacity-0 hover:shadow-2xl transition-all duration-500 text-left group hover:scale-105`;
        btn.style.animation = `slide-up 0.6s ease-out ${index * 0.08}s both`;
        btn.innerHTML = `
          <div class="flex items-start justify-between mb-4">
            <i data-lucide="${m.icon}" class="bg-gradient-to-r ${m.color} bg-clip-text text-transparent group-hover:scale-110 transition-transform"></i>
            <i data-lucide="play" class="text-gray-400 group-hover:text-white transition-colors"></i>
          </div>
          <h3 class="text-2xl font-bold mb-2 text-white">${m.title}</h3>
          <p class="text-gray-300 font-light">${m.description}</p>
        `;
        btn.addEventListener("click", async () => {
          await ensureAudio();
          playSound("C5", "8n");
          showGame(m.id);
        });
        grid.appendChild(btn);
      });

      lucide.createIcons();
    }

    // -------------------------
    // Module 1: Cause & Effect
    // -------------------------
    function renderCauseEffect() {
      const scenarios = [
        {
          situation: "A city notices increased traffic congestion",
          options: [
            { id: 1, text: "Population growth", isCorrect: true },
            { id: 2, text: "More cars on roads", isCorrect: true },
            { id: 3, text: "Weather changes", isCorrect: false },
            { id: 4, text: "Inadequate public transport", isCorrect: true },
            { id: 5, text: "Road construction", isCorrect: true },
            { id: 6, text: "People working from home", isCorrect: false }
          ],
          explanation:
            "Multiple factors contribute: population growth leads to more cars, while inadequate public transport and road construction worsen the problem."
        },
        {
          situation: "Students perform better on tests after a new teaching method",
          options: [
            { id: 1, text: "Better student engagement", isCorrect: true },
            { id: 2, text: "Clearer explanations", isCorrect: true },
            { id: 3, text: "Longer school year", isCorrect: false },
            { id: 4, text: "More practice opportunities", isCorrect: true },
            { id: 5, text: "Stricter grading", isCorrect: false },
            { id: 6, text: "Enhanced understanding", isCorrect: true }
          ],
          explanation:
            "The new method works through engagement, clarity, and practice, leading to better understanding."
        }
      ];

      let current = 0;
      let selected = new Set();
      let showFeedback = false;

      function draw() {
        const s = scenarios[current];

        gameHost.innerHTML = `
          <div class="space-y-6 animate-fade-in">
            <div class="bg-gradient-to-r from-cyan-500/10 to-blue-600/10 p-6 rounded-2xl border border-cyan-500/30">
              <h3 class="text-2xl font-bold text-cyan-400 mb-3">Scenario ${current + 1}</h3>
              <p class="text-gray-200 text-lg">${s.situation}</p>
              <p class="text-cyan-300 mt-3 text-sm">Select ALL factors that contribute to this situation:</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="ceOptions"></div>

            <div id="ceFooter"></div>
          </div>
        `;

        const optionsEl = document.getElementById("ceOptions");
        s.options.forEach((o) => {
          const isSel = selected.has(o.id);
          const btn = document.createElement("button");
          btn.disabled = showFeedback;
          btn.className = `
            p-5 rounded-xl border-2 transition-all duration-300 text-left
            ${isSel ? "bg-cyan-500/20 border-cyan-400 scale-105 shadow-lg shadow-cyan-500/20" : "bg-gray-800/50 border-gray-700 hover:border-cyan-500/50 hover:bg-gray-800/70"}
            ${showFeedback && o.isCorrect && !isSel ? "border-green-500 bg-green-500/10" : ""}
            ${showFeedback && !o.isCorrect && isSel ? "border-red-500 bg-red-500/10" : ""}
          `;
          btn.innerHTML = `
            <div class="flex items-center justify-between gap-3">
              <span class="text-gray-200 font-medium">${o.text}</span>
              <span class="shrink-0">
                ${showFeedback && o.isCorrect ? '<i data-lucide="check-circle" class="text-green-400"></i>' : ""}
                ${showFeedback && !o.isCorrect && isSel ? '<i data-lucide="x-circle" class="text-red-400"></i>' : ""}
              </span>
            </div>
          `;
          btn.addEventListener("click", async () => {
            await ensureAudio();
            if (showFeedback) return;
            if (selected.has(o.id)) {
              selected.delete(o.id);
              playSound("C4", "32n");
            } else {
              selected.add(o.id);
              playSound("E4", "32n");
            }
            draw();
          });
          optionsEl.appendChild(btn);
        });

        const footer = document.getElementById("ceFooter");
        if (!showFeedback) {
          const btn = document.createElement("button");
          btn.disabled = selected.size === 0;
          btn.className =
            "w-full py-4 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-xl font-bold text-white hover:scale-105 transition-transform disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100";
          btn.textContent = "Check Answer";
          btn.addEventListener("click", async () => {
            await ensureAudio();
            const correctIds = s.options.filter(x => x.isCorrect).map(x => x.id);
            const isCorrect = correctIds.length === selected.size && correctIds.every(id => selected.has(id));
            showFeedback = true;
            if (isCorrect) {
              playSound("G5", "8n");
              setTimeout(() => playSound("C6", "8n"), 100);
              setScore(state.score + 10);
            } else {
              playSound("C3", "8n");
            }
            draw();
          });
          footer.appendChild(btn);
        } else {
          footer.innerHTML = `
            <div class="bg-gradient-to-r from-blue-500/10 to-purple-500/10 p-6 rounded-2xl border border-blue-500/30 animate-slide-up">
              <div class="flex items-start gap-3">
                <i data-lucide="lightbulb" class="text-yellow-400 mt-1 shrink-0"></i>
                <div>
                  <h4 class="text-xl font-bold text-blue-300 mb-2">Analysis</h4>
                  <p class="text-gray-200">${s.explanation}</p>
                </div>
              </div>
              <button id="ceNext" class="mt-4 px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-xl font-bold text-white hover:scale-105 transition-transform flex items-center gap-2">
                ${current < scenarios.length - 1 ? "Next Scenario" : "Complete Module"}
                <i data-lucide="arrow-right"></i>
              </button>
            </div>
          `;
          document.getElementById("ceNext").addEventListener("click", async () => {
            await ensureAudio();
            if (current < scenarios.length - 1) {
              current += 1;
              selected = new Set();
              showFeedback = false;
              draw();
            } else {
              showHome();
            }
          });
        }

        lucide.createIcons();
      }

      draw();
    }

    // -------------------------
    // Module 2: Argument Analyzer
    // -------------------------
    function renderArgument() {
      const cases = [
        {
          argument: "Studies show that students who eat breakfast score higher on tests. Therefore, schools should provide free breakfast to all students to improve academic performance.",
          question: "What's the logical structure of this argument?",
          options: [
            { id: 1, text: "Correlation implies causation (flawed)", correct: true, explanation: "It assumes breakfast causes better scores. But correlation doesn’t prove causation—other factors (sleep, income, routines) could explain both." },
            { id: 2, text: "Valid causal inference", correct: false, explanation: "Without controlling variables, we can’t claim breakfast directly causes higher scores." },
            { id: 3, text: "Appeal to emotion only", correct: false, explanation: "It uses evidence (studies), not only emotion." }
          ]
        },
        {
          argument: "Every successful entrepreneur I've met wakes up before 6 AM. If you want to be successful, you should wake up early too.",
          question: "What reasoning problem is present here?",
          options: [
            { id: 1, text: "Anecdotal evidence / small sample", correct: true, explanation: "Personal observations aren’t representative; waking early may not cause success." },
            { id: 2, text: "Sound logical reasoning", correct: false, explanation: "This conclusion is based on limited experience, not robust evidence." },
            { id: 3, text: "Circular reasoning", correct: false, explanation: "The conclusion doesn’t restate the premise." }
          ]
        }
      ];

      let idx = 0;
      let selectedId = null;
      let show = false;

      function draw() {
        const c = cases[idx];
        gameHost.innerHTML = `
          <div class="space-y-6 animate-fade-in">
            <div class="bg-gradient-to-r from-purple-500/10 to-pink-600/10 p-6 rounded-2xl border border-purple-500/30">
              <h3 class="text-2xl font-bold text-purple-400 mb-4">Case ${idx + 1}: Analyze the Argument</h3>
              <div class="bg-gray-900/50 p-5 rounded-xl border-l-4 border-purple-500">
                <p class="text-gray-200 text-lg italic">"${c.argument}"</p>
              </div>
            </div>

            <div class="bg-gradient-to-r from-pink-500/10 to-purple-600/10 p-5 rounded-xl border border-pink-500/30">
              <p class="text-pink-300 font-semibold">${c.question}</p>
            </div>

            <div class="space-y-3" id="argOptions"></div>

            <div id="argFooter"></div>
          </div>
        `;

        const optEl = document.getElementById("argOptions");
        c.options.forEach(o => {
          const btn = document.createElement("button");
          btn.disabled = show;
          btn.className = `
            w-full p-5 rounded-xl border-2 transition-all duration-300 text-left
            ${selectedId === o.id ? "bg-purple-500/20 border-purple-400 scale-[1.02] shadow-lg shadow-purple-500/20" : "bg-gray-800/50 border-gray-700 hover:border-purple-500/50 hover:bg-gray-800/70"}
          `;
          btn.innerHTML = `<span class="text-gray-200 font-medium">${o.text}</span>`;
          btn.addEventListener("click", async () => {
            await ensureAudio();
            if (show) return;
            selectedId = o.id;
            playSound("A4", "16n");
            draw();
          });
          optEl.appendChild(btn);
        });

        const footer = document.getElementById("argFooter");
        const chosen = c.options.find(o => o.id === selectedId);

        if (!show) {
          const btn = document.createElement("button");
          btn.disabled = !selectedId;
          btn.className =
            "w-full py-4 bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl font-bold text-white hover:scale-105 transition-transform disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100";
          btn.textContent = "Submit Analysis";
          btn.addEventListener("click", async () => {
            await ensureAudio();
            if (!chosen) return;
            show = true;
            if (chosen.correct) {
              playSound("G5", "8n");
              setTimeout(() => playSound("C6", "8n"), 100);
              setScore(state.score + 15);
            } else {
              playSound("C3", "8n");
            }
            draw();
          });
          footer.appendChild(btn);
        } else if (chosen) {
          footer.innerHTML = `
            <div class="p-6 rounded-2xl border-2 animate-slide-up ${chosen.correct ? "bg-green-500/10 border-green-500/50" : "bg-orange-500/10 border-orange-500/50"}">
              <div class="flex items-start gap-3 mb-3">
                <i data-lucide="${chosen.correct ? "check-circle" : "lightbulb"}" class="${chosen.correct ? "text-green-400" : "text-orange-400"} mt-1 shrink-0"></i>
                <div>
                  <h4 class="text-xl font-bold mb-2 ${chosen.correct ? "text-green-400" : "text-orange-400"}">
                    ${chosen.correct ? "Excellent Analysis!" : "Let’s Think Deeper"}
                  </h4>
                  <p class="text-gray-200">${chosen.explanation}</p>
                </div>
              </div>
              <button id="argNext" class="mt-4 px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl font-bold text-white hover:scale-105 transition-transform flex items-center gap-2">
                ${idx < cases.length - 1 ? "Next Case" : "Complete Module"}
                <i data-lucide="arrow-right"></i>
              </button>
            </div>
          `;
          document.getElementById("argNext").addEventListener("click", async () => {
            await ensureAudio();
            if (idx < cases.length - 1) {
              idx += 1;
              selectedId = null;
              show = false;
              draw();
            } else {
              showHome();
            }
          });
        }

        lucide.createIcons();
      }

      draw();
    }

    // -------------------------
    // Module 3: Systems Thinking
    // -------------------------
    function renderSystems() {
      const system = {
        name: "Forest Ecosystem",
        components: ["Trees", "Soil", "Water", "Animals", "Sunlight", "Decomposers"],
        connections: {
          Trees: ["Water", "Sunlight", "Soil", "Animals"],
          Soil: ["Trees", "Water", "Decomposers"],
          Water: ["Trees", "Soil", "Animals"],
          Animals: ["Trees", "Water", "Decomposers"],
          Sunlight: ["Trees"],
          Decomposers: ["Soil", "Animals"]
        },
        explanation:
          "In a forest ecosystem, everything is interconnected. Trees need water, sunlight, and soil nutrients. Animals depend on trees and water. Decomposers recycle nutrients back into soil."
      };

      let show = false;

      function draw() {
        gameHost.innerHTML = `
          <div class="space-y-6 animate-fade-in">
            <div class="bg-gradient-to-r from-orange-500/10 to-red-600/10 p-6 rounded-2xl border border-orange-500/30">
              <h3 class="text-2xl font-bold text-orange-400 mb-3">System: ${system.name}</h3>
              <p class="text-gray-200">Tap components to explore, then reveal the system map.</p>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="sysGrid"></div>

            <div id="sysFooter"></div>
          </div>
        `;

        const grid = document.getElementById("sysGrid");
        system.components.forEach((c, i) => {
          const btn = document.createElement("button");
          btn.className =
            "w-full p-6 bg-gradient-to-br from-orange-500/20 to-red-600/20 rounded-2xl border-2 border-orange-500/40 hover:scale-105 transition-all duration-300 font-bold text-white text-lg shadow-lg";
          btn.style.animationDelay = `${i * 0.08}s`;
          btn.classList.add("floaty");
          btn.textContent = c;
          btn.addEventListener("click", async () => {
            await ensureAudio();
            playSound("D4", "32n");
          });
          grid.appendChild(btn);
        });

        const footer = document.getElementById("sysFooter");
        if (!show) {
          const btn = document.createElement("button");
          btn.className = "w-full py-4 bg-gradient-to-r from-orange-500 to-red-600 rounded-xl font-bold text-white hover:scale-105 transition-transform";
          btn.textContent = "Show System Map";
          btn.addEventListener("click", async () => {
            await ensureAudio();
            show = true;
            playSound("G5", "4n");
            setScore(state.score + 20);
            draw();
          });
          footer.appendChild(btn);
        } else {
          footer.innerHTML = `
            <div class="bg-gradient-to-r from-green-500/10 to-emerald-500/10 p-6 rounded-2xl border border-green-500/30 animate-slide-up">
              <div class="flex items-start gap-3">
                <i data-lucide="target" class="text-green-400 mt-1 shrink-0"></i>
                <div>
                  <h4 class="text-xl font-bold text-green-400 mb-3">System Map</h4>
                  <p class="text-gray-200 mb-4">${system.explanation}</p>

                  <div class="space-y-2">
                    ${Object.entries(system.connections).map(([k,v]) => `
                      <div class="bg-gray-900/50 p-3 rounded-lg">
                        <span class="text-orange-400 font-semibold">${k}</span>
                        <span class="text-gray-400"> → </span>
                        <span class="text-gray-200">${v.join(", ")}</span>
                      </div>
                    `).join("")}
                  </div>

                  <button id="sysDone" class="mt-5 px-6 py-3 bg-gradient-to-r from-orange-500 to-red-600 rounded-xl font-bold text-white hover:scale-105 transition-transform flex items-center gap-2">
                    Complete Module
                    <i data-lucide="arrow-right"></i>
                  </button>
                </div>
              </div>
            </div>
          `;
          document.getElementById("sysDone").addEventListener("click", async () => {
            await ensureAudio();
            showHome();
          });
        }

        lucide.createIcons();
      }

      draw();
    }

    // -------------------------
    // Module 4: Scientific Method
    // -------------------------
    function renderScientific() {
      const experiment = {
        question: "Why do plants grow taller near the window?",
        steps: [
          {
            step: "Observation",
            prompt: "What did we observe?",
            options: [
              { text: "Plants near window are taller", correct: true },
              { text: "Plants are all the same height", correct: false },
              { text: "Windows are bigger than walls", correct: false }
            ]
          },
          {
            step: "Hypothesis",
            prompt: "What might explain this?",
            options: [
              { text: "Plants grow toward light (phototropism)", correct: true },
              { text: "Windows make plants happy", correct: false },
              { text: "Temperature near windows is better", correct: false }
            ]
          },
          {
            step: "Experiment Design",
            prompt: "How can we test this?",
            options: [
              { text: "Grow identical plants: some with light, some without", correct: true },
              { text: "Ask the plants what they prefer", correct: false },
              { text: "Assume the hypothesis is true", correct: false }
            ]
          },
          {
            step: "Data Collection",
            prompt: "What should we measure?",
            options: [
              { text: "Plant height and growth rate over time", correct: true },
              { text: "How green the plants look", correct: false },
              { text: "The color of the pots", correct: false }
            ]
          },
          {
            step: "Conclusion",
            prompt: "If plants with light grew taller, what can we conclude?",
            options: [
              { text: "Light promotes plant growth (hypothesis supported)", correct: true },
              { text: "All plants prefer windows", correct: false },
              { text: "We need to test more variables", correct: false }
            ]
          }
        ]
      };

      let step = 0;
      const answers = {};
      let show = false;

      function draw() {
        const s = experiment.steps[step];

        gameHost.innerHTML = `
          <div class="space-y-6 animate-fade-in">
            <div class="bg-gradient-to-r from-green-500/10 to-emerald-600/10 p-6 rounded-2xl border border-green-500/30">
              <h3 class="text-2xl font-bold text-green-400 mb-3">Research Question</h3>
              <p class="text-gray-200 text-lg italic">"${experiment.question}"</p>
            </div>

            <div class="flex items-center justify-center gap-2 mb-2">
              ${experiment.steps.map((_, i) => `
                <div class="h-2 rounded-full transition-all duration-300 ${
                  i === step ? "w-12 bg-gradient-to-r from-green-500 to-emerald-600" :
                  i < step ? "w-8 bg-green-600" : "w-8 bg-gray-700"
                }"></div>
              `).join("")}
            </div>

            <div class="bg-gradient-to-br from-emerald-500/20 to-green-600/20 p-6 rounded-2xl border-2 border-emerald-500/40">
              <div class="flex items-center gap-3 mb-4">
                <i data-lucide="microscope" class="text-emerald-400"></i>
                <h4 class="text-2xl font-bold text-emerald-300">Step ${step + 1}: ${s.step}</h4>
              </div>
              <p class="text-gray-200 text-lg">${s.prompt}</p>
            </div>

            <div class="space-y-3" id="sciOptions"></div>

            <div id="sciFooter"></div>
          </div>
        `;

        const optEl = document.getElementById("sciOptions");
        s.options.forEach((o) => {
          const isSel = answers[step] === o.text;
          const btn = document.createElement("button");
          btn.disabled = show;
          btn.className = `
            w-full p-5 rounded-xl border-2 transition-all duration-300 text-left
            ${isSel ? "bg-green-500/20 border-green-400 scale-[1.02] shadow-lg shadow-green-500/20" : "bg-gray-800/50 border-gray-700 hover:border-green-500/50 hover:bg-gray-800/70"}
          `;
          btn.innerHTML = `<span class="text-gray-200 font-medium">${o.text}</span>`;
          btn.addEventListener("click", async () => {
            await ensureAudio();
            if (show) return;
            answers[step] = o.text;
            playSound("E4", "16n");
            draw();
          });
          optEl.appendChild(btn);
        });

        const footer = document.getElementById("sciFooter");
        const selected = s.options.find(o => o.text === answers[step]);

        if (!show) {
          const btn = document.createElement("button");
          btn.disabled = !selected;
          btn.className =
            "w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl font-bold text-white hover:scale-105 transition-transform disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100";
          btn.textContent = "Submit Answer";
          btn.addEventListener("click", async () => {
            await ensureAudio();
            if (!selected) return;
            show = true;
            if (selected.correct) {
              playSound("G5", "8n");
              setScore(state.score + 10);
            } else {
              playSound("C3", "8n");
            }
            draw();
          });
          footer.appendChild(btn);
        } else if (selected) {
          const correctText = s.options.find(o => o.correct)?.text || "";
          footer.innerHTML = `
            <div class="p-6 rounded-2xl border-2 animate-slide-up ${selected.correct ? "bg-green-500/10 border-green-500/50" : "bg-yellow-500/10 border-yellow-500/50"}">
              <div class="flex items-start gap-3">
                <i data-lucide="${selected.correct ? "check-circle" : "lightbulb"}" class="${selected.correct ? "text-green-400" : "text-yellow-400"} mt-1 shrink-0"></i>
                <div>
                  <h4 class="text-xl font-bold mb-2 ${selected.correct ? "text-green-400" : "text-yellow-400"}">
                    ${selected.correct ? "Correct!" : "Not quite"}
                  </h4>
                  <p class="text-gray-200">
                    ${selected.correct ? `Great thinking! This is how scientists approach the ${s.step.toLowerCase()} step.` : `The correct answer is: "${correctText}"`}
                  </p>
                </div>
              </div>

              <button id="sciNext" class="mt-4 px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl font-bold text-white hover:scale-105 transition-transform flex items-center gap-2">
                ${step < experiment.steps.length - 1 ? "Next Step" : "Complete Experiment"}
                <i data-lucide="arrow-right"></i>
              </button>
            </div>
          `;

          document.getElementById("sciNext").addEventListener("click", async () => {
            await ensureAudio();
            if (step < experiment.steps.length - 1) {
              step += 1;
              show = false;
              draw();
            } else {
              showHome();
            }
          });
        }

        lucide.createIcons();
      }

      draw();
    }

    // -------------------------
    // Router: render selected module
    // -------------------------
    function renderGame(moduleId) {
      // clear old
      gameHost.innerHTML = "";
      if (moduleId === "cause-effect") return renderCauseEffect();
      if (moduleId === "argument") return renderArgument();
      if (moduleId === "systems") return renderSystems();
      if (moduleId === "scientific") return renderScientific();
      gameHost.innerHTML = `<div class="p-6 rounded-2xl border border-gray-700 bg-gray-800/40">Unknown module.</div>`;
    }

    // Boot
    renderHomeCards();
    lucide.createIcons();
  </script>
</body>
</html>
